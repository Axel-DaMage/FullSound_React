name: ðŸ“¡ Verificar y Notificar IP de EC2

# Verifica cada hora si la IP cambiÃ³ y notifica
on:
  schedule:
    - cron: '*/30 * * * *'  # Cada 30 minutos
  workflow_dispatch:

jobs:
  check-ip:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ðŸ” Configurar AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: us-east-1

    - name: ðŸ” Obtener IP actual
      id: current-ip
      run: |
        CURRENT_IP=$(aws ec2 describe-instances \
          --filters "Name=instance-state-name,Values=running" \
          --query "Reservations[0].Instances[0].PublicIpAddress" \
          --output text)
        
        echo "CURRENT_IP=$CURRENT_IP" >> $GITHUB_OUTPUT
        echo "ðŸ“ IP actual: $CURRENT_IP"

    - name: ðŸ“„ Leer IP guardada
      id: saved-ip
      run: |
        if [ -f .env.production ]; then
          SAVED_IP=$(grep VITE_API_URL .env.production | cut -d'/' -f3 | cut -d':' -f1)
          echo "SAVED_IP=$SAVED_IP" >> $GITHUB_OUTPUT
          echo "ðŸ’¾ IP guardada: $SAVED_IP"
        else
          echo "SAVED_IP=none" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ”„ Actualizar si cambiÃ³
      if: steps.current-ip.outputs.CURRENT_IP != steps.saved-ip.outputs.SAVED_IP
      run: |
        echo "âš ï¸ Â¡La IP cambiÃ³!"
        echo "Antigua: ${{ steps.saved-ip.outputs.SAVED_IP }}"
        echo "Nueva: ${{ steps.current-ip.outputs.CURRENT_IP }}"
        
        # Actualizar .env.production
        cat > .env.production << EOF
        # Auto-actualizado: $(date)
        # IP anterior: ${{ steps.saved-ip.outputs.SAVED_IP }}
        # IP nueva: ${{ steps.current-ip.outputs.CURRENT_IP }}
        VITE_API_URL=http://${{ steps.current-ip.outputs.CURRENT_IP }}:8080/api
        VITE_SUPABASE_PROJECT_URL=https://kivpcepyhfpqjfoycwel.supabase.co
        VITE_SUPABASE_BUCKET_IMAGES=Imagenes
        VITE_SUPABASE_BUCKET_AUDIO=audios
        VITE_APP_NAME=FullSound
        EOF
        
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .env.production
        git commit -m "ðŸš¨ IP cambiÃ³: ${{ steps.saved-ip.outputs.SAVED_IP }} â†’ ${{ steps.current-ip.outputs.CURRENT_IP }}"
        git push

    - name: âœ… Sin cambios
      if: steps.current-ip.outputs.CURRENT_IP == steps.saved-ip.outputs.SAVED_IP
      run: |
        echo "âœ… La IP no ha cambiado: ${{ steps.current-ip.outputs.CURRENT_IP }}"
