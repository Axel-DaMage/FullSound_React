name: ðŸ”„ Actualizar IP de EC2 (Manual)

# Este workflow se ejecuta manualmente desde GitHub Actions
# Ãštil cuando reinicies AWS Learner Lab

on:
  workflow_dispatch:
    inputs:
      ec2_ip:
        description: 'IP pÃºblica de EC2 (dejar vacÃ­o para auto-detectar)'
        required: false
        type: string

jobs:
  update-ip:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ðŸ” Configurar AWS (si se auto-detecta)
      if: ${{ github.event.inputs.ec2_ip == '' }}
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: us-east-1

    - name: ðŸ” Detectar o usar IP proporcionada
      id: get-ip
      run: |
        if [ -n "${{ github.event.inputs.ec2_ip }}" ]; then
          EC2_IP="${{ github.event.inputs.ec2_ip }}"
          echo "ðŸ“ Usando IP proporcionada: $EC2_IP"
        else
          EC2_IP=$(aws ec2 describe-instances \
            --filters "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "ðŸ” IP auto-detectada: $EC2_IP"
        fi
        
        if [ "$EC2_IP" == "None" ] || [ -z "$EC2_IP" ]; then
          echo "âŒ Error: No se pudo obtener la IP"
          exit 1
        fi
        
        echo "EC2_IP=$EC2_IP" >> $GITHUB_OUTPUT

    - name: ðŸ“ Actualizar archivos .env
      run: |
        # Actualizar .env.production
        cat > .env.production << EOF
        # Auto-actualizado por GitHub Actions
        # Fecha: $(date)
        # IP: ${{ steps.get-ip.outputs.EC2_IP }}
        VITE_API_URL=http://${{ steps.get-ip.outputs.EC2_IP }}:8080/api
        VITE_SUPABASE_PROJECT_URL=https://kivpcepyhfpqjfoycwel.supabase.co
        VITE_SUPABASE_BUCKET_IMAGES=Imagenes
        VITE_SUPABASE_BUCKET_AUDIO=audios
        VITE_APP_NAME=FullSound
        EOF
        
        echo "âœ… Archivo .env.production actualizado"

    - name: ðŸ’¾ Commit y Push
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .env.production
        git commit -m "ðŸ”„ Auto-update EC2 IP: ${{ steps.get-ip.outputs.EC2_IP }}" || echo "No hay cambios"
        git push

    - name: âœ… Resumen
      run: |
        echo "ðŸŽ‰ IP actualizada correctamente!"
        echo "ðŸ“ Nueva IP: ${{ steps.get-ip.outputs.EC2_IP }}"
        echo "ðŸŒ URL del backend: http://${{ steps.get-ip.outputs.EC2_IP }}:8080/api"
