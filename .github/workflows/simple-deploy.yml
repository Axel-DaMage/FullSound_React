# ü§ñ Gu√≠a de Configuraci√≥n - GitHub Actions para AWS Learner Lab

## üìã Workflows Creados

### 1. **auto-deploy.yml** - Deployment Autom√°tico
- Detecta la IP de EC2 autom√°ticamente
- Construye el proyecto con la IP correcta
- Despliega a Vercel autom√°ticamente
- Se ejecuta: En cada push, cada hora, o manualmente

### 2. **update-ip.yml** - Actualizaci√≥n Manual de IP
- Actualiza la IP cuando reinicies Learner Lab
- Puedes proporcionarla manualmente o auto-detectarla
- Hace commit del cambio autom√°ticamente
- Se ejecuta: Solo manualmente desde GitHub

### 3. **check-ip.yml** - Monitoreo de IP
- Verifica cada 30 minutos si la IP cambi√≥
- Actualiza autom√°ticamente si detecta cambios
- √ötil cuando el Learner Lab se reinicia

---

## üîê Configuraci√≥n Requerida

### Paso 1: Obtener Credenciales de AWS Learner Lab

**Cada vez que inicies AWS Learner Lab:**

1. **Inicia el laboratorio** en AWS Academy
2. Click en **"AWS Details"**
3. Click en **"Show"** en AWS CLI
4. Copia las credenciales que aparecen:

```bash
[default]
aws_access_key_id=ASIA...
aws_secret_access_key=...
aws_session_token=...
```

### Paso 2: Configurar Secrets en GitHub

1. Ve a tu repositorio en GitHub
2. **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions**
3. Click en **"New repository secret"**
4. Agrega estos secrets:

| Secret Name | Valor | Descripci√≥n |
|-------------|-------|-------------|
| `AWS_ACCESS_KEY_ID` | `ASIA...` | De AWS CLI credentials |
| `AWS_SECRET_ACCESS_KEY` | `...` | De AWS CLI credentials |
| `AWS_SESSION_TOKEN` | `FwoGZXIvYXdzE...` | De AWS CLI credentials (largo) |

‚ö†Ô∏è **IMPORTANTE:** Estas credenciales expiran cuando termina tu sesi√≥n de Learner Lab (t√≠picamente 4 horas). Necesitar√°s actualizarlas cada vez que reinicies el lab.

### Paso 3: Configurar Vercel (Opcional pero Recomendado)

1. **Crea cuenta en Vercel:**
   - Ve a [vercel.com](https://vercel.com)
   - Conecta con GitHub

2. **Obt√©n tokens de Vercel:**
   
   a. **VERCEL_TOKEN:**
   - Settings ‚Üí Tokens ‚Üí Create
   - Copia el token

   b. **VERCEL_ORG_ID y VERCEL_PROJECT_ID:**
   ```bash
   # Instala Vercel CLI
   npm i -g vercel
   
   # Login
   vercel login
   
   # En tu proyecto
   vercel link
   
   # Ver√°s los IDs en .vercel/project.json
   cat .vercel/project.json
   ```

3. **Agrega a GitHub Secrets:**
   - `VERCEL_TOKEN`
   - `VERCEL_ORG_ID`
   - `VERCEL_PROJECT_ID`

---

## üöÄ Uso de los Workflows

### Opci√≥n 1: Actualizaci√≥n Manual (M√°s Simple)

**Cuando reinicies Learner Lab:**

1. **Actualiza los secrets de AWS** (pasos de arriba)
2. Ve a **Actions** en GitHub
3. Selecciona **"üîÑ Actualizar IP de EC2"**
4. Click en **"Run workflow"**
5. Opci√≥n A: Deja vac√≠o para auto-detectar
6. Opci√≥n B: Ingresa la IP manualmente
7. Click en **"Run workflow"**

### Opci√≥n 2: Auto-deployment Completo

1. **Push tu c√≥digo:**
```powershell
git add .
git commit -m "Update code"
git push
```

2. **GitHub Actions autom√°ticamente:**
   - Detecta la IP de EC2
   - Construye el proyecto
   - Despliega a Vercel
   - ¬°Todo autom√°tico! üéâ

### Opci√≥n 3: Monitoreo Autom√°tico

El workflow `check-ip.yml` verifica cada 30 minutos si la IP cambi√≥ y actualiza autom√°ticamente.

---

## üì± Workflow Sin AWS Credentials (M√°s Simple)

Si no quieres lidiar con credentials de AWS que expiran, usa este flujo:

<function_calls>
<invoke name="create_file">
<parameter name="content">name: üîÑ Actualizar IP - Simple (Sin AWS CLI)

# Workflow simple que solo requiere que ingreses la IP manualmente

on:
  workflow_dispatch:
    inputs:
      ec2_ip:
        description: 'IP p√∫blica de tu EC2 (ej: 54.227.183.6)'
        required: true
        type: string

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üìù Actualizar .env.production
      run: |
        cat > .env.production << EOF
        # Actualizado manualmente v√≠a GitHub Actions
        # Fecha: $(date)
        # IP proporcionada: ${{ github.event.inputs.ec2_ip }}
        VITE_API_URL=http://${{ github.event.inputs.ec2_ip }}:8080/api
        VITE_SUPABASE_PROJECT_URL=https://kivpcepyhfpqjfoycwel.supabase.co
        VITE_SUPABASE_BUCKET_IMAGES=Imagenes
        VITE_SUPABASE_BUCKET_AUDIO=audios
        VITE_APP_NAME=FullSound
        EOF
        
        echo "‚úÖ Archivo .env.production creado con IP: ${{ github.event.inputs.ec2_ip }}"
        cat .env.production

    - name: üì¶ Instalar dependencias
      run: npm ci

    - name: üèóÔ∏è Build del proyecto
      run: npm run build

    - name: ‚úÖ Verificar build
      run: |
        echo "üì¶ Build completado. Contenido de dist/:"
        ls -la dist/

    - name: üöÄ Deploy a Vercel
      if: ${{ secrets.VERCEL_TOKEN != '' }}
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'

    - name: üìä Resumen
      run: |
        echo "üéâ Proceso completado!"
        echo "üìç IP configurada: ${{ github.event.inputs.ec2_ip }}"
        echo "üåê Backend URL: http://${{ github.event.inputs.ec2_ip }}:8080/api"
        echo "‚úÖ Build generado en ./dist"
